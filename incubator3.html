<!DOCTYPE html>
<html class="js canvas canvastext geolocation rgba hsla no-multiplebgs borderimage borderradius boxshadow opacity no-cssanimations csscolumns no-cssgradients no-cssreflections csstransforms no-csstransforms3d no-csstransitions  video audio cufon-active fontface cufon-ready">
<head>
	<meta charset="utf-8" />
	
	
		<!-- STYLES -->
	
		<link rel="stylesheet/less" href="css/ergo-js.less" type="text/x-less" />

		<link rel="stylesheet/less" href="themes/default/ergo-theme.less" type="text/-less" />

		<link rel="stylesheet/less" href="iconsets/font-awesome/less/font-awesome.less" type="text/css" />

		<script src="lib/misc/less-1.3.1.min.js" type="text/javascript"></script>

		<script src="lib/misc/jquery-1.8.2.min.js" type="text/javascript"></script>
		<script src="build/ergo-js-0.9.2.js" type="text/javascript"></script>

		<script src="plugins/ergo-growl/ergo-growl.js" type="text/javascript"></script>

		<script src="incubator/utils.js" type="text/javascript"></script>
		
    <!--script src="http://api-maps.yandex.ru/2.0-stable/?load=package.standard&lang=ru-RU" type="text/javascript"></script-->
	
	
	<style type="text/css">
		
		body {
			padding: 20px;
		}
		
		.context-menu {
			margin-right: 5px;
			margin-bottom: 5px;
		}
		
	</style>
	
</head>
<body>
	
	
<script type="text/javascript">
	
	
	var DummyServer = {
		
		last_id: 1,
		
		get: function(path) {
			return $.when( Ergo.deep_copy(DummyTreeData[path]) );
		},
		
		put: function(obj, parent_id) {
			var id = this.last_id++;
			
			if(!DummyTreeData[parent_id])
				DummyTreeData[parent_id] = [];
			
			obj.id = 'uid-'+id;
			
			DummyTreeData[parent_id].push(obj);
			
			console.log({'PUT': obj});
			
			return $.when( Ergo.deep_copy(obj) );
		},
		
		del: function(id) {
			
			console.log(id);
			
			Ergo.each(DummyTreeData, function(arr) {
				new Ergo.core.Array(arr).remove_if(function(item){
					return item.id == id;
				});
			});
			
			return $.when(true);
		}
		
		
	};
	
	
	
	
	
	


	var context_menu = $.ergo({
		etype: 'dropdown-box',
		cls: 'context-menu',
		position: {
			boundary: 'push'
		},		
		content: {
			items: [{
				text: 'Удалить',
				tag: 'delete'
			}, 
			{cls: 'e-splitter'}, 
			{
				text: 'Добавить', 
				tag: 'new'
			}, {
				text: 'Изменить', 
//				state: 'disabled',
				tag: 'edit'
			}],
			defaultItem: {
				onClick: function() {
					this.events.bubble(this.tag);
				}
			}			
		},
		effects: {
			delay: 0
		},
		width: 200,
		
		onNew: function(e) {
			
			var node = this._target.parent;
			
			var obj = {
				title: "Новый каталог",
				type: "folder",
				children: []
			};
			
			var parent_id = node.data.oid();
			
			if(node.states.is('expanded')) {
				DummyServer.put(obj, parent_id).then(function(data){
					node.subtree.data.add(data);				
				});				
			}
			else {
				DummyServer.put(obj, parent_id).then(function(data){
					node.states.set('expanded');
				});				
			}
			
			this.close();
		},
		
		
		onDelete: function() {

			var node = this._target.parent;
			
			DummyServer.del( node.data.oid() ).then(function(){
				node.data.del();
			});
			
			this.close();
		}
		
		
//		hideOn: 'hoverOut'
	});


	
	var FileTreeModel = Ergo.incubator.tree.FileNodeList.extend({

		model: Ergo.data.tree.AjaxNode.extend({
			fields: {
				'children': 'FileTreeModel'
			},
			
			isDir: function() {
				return this.get('type') == 'folder';
			}
			
		}),
		
		fetch: function(id) {
			
			var self = this;
			
			if(!id) id = 0;
			
			return DummyServer.get(id).then(function(data){
				self._fetched = true;
				self.set(data);				
			});
			
			
		}
		
	});


	var treeData = new FileTreeModel({url: 'plugins/ajax-tree/ajax/tree'});
	
	var w = $.ergo({
		etype: 'panel',
		renderTo: 'body',
		width: 600,
		height: 300,
		title: 'Динамическое дерево + файловый источник данных',
		cls: 'widget',
		style: {'margin-bottom': 20},
	
		
		content: {
			etype: 'dynamic-tree',
			
			data: treeData,
			
			autoFetch: true,
			
			mixins: ['selectable'],
			
			node: {				
				content: {
					cls: 'cursor-default',
					binding: function(v) {
						this.opt('icon', v.children ? 'icon-folder-close' : 'icon-file' );
						this.opt('text', v.title);
					},
					onDoubleClick: function() {
						if(!this.parent.states.is('leaf'))
							this.parent.states.toggle('expanded');
					},
					onClick: function() {
						this.events.bubble('selected', {target: this.parent});
					},
					state: 'no-selection',
					mixins: ['contextmenu'],
					contextMenu: context_menu,
					
					onContextMenu: function() {
						this.events.bubble('selected', {target: this.parent});
					}
				},
				mixins: ['effects'],
				effects: {
					show: 'fadeOut',
					hide: 'fadeIn',
					delay: 500
				}
			},
			
			// onSelected: function(e) {
				// console.log(e.target);
			// }
			selectOn: 'selected'
							
		}		
		
		
	});	
	
	
	
	
	
	$.ergo({
		etype: 'panel',
		renderTo: 'body',
		height: 300,
		cls: 'widget',
		style: {'margin-bottom': 20},
		
		mixins: ['contextmenu'],
				
		contextMenu: context_menu
		
	});
	
	


</script>
</body>