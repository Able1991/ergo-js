<!DOCTYPE html>
<html class="js canvas canvastext geolocation rgba hsla no-multiplebgs borderimage borderradius boxshadow opacity no-cssanimations csscolumns no-cssgradients no-cssreflections csstransforms no-csstransforms3d no-csstransitions  video audio cufon-active fontface cufon-ready">
<head>
	<meta charset="utf-8" />
	
	
		<!-- STYLES -->
	
		<link rel="stylesheet/less" href="css/ergo-js.less" type="text/x-less" />

		<link rel="stylesheet/less" href="themes/default/ergo-theme.less" type="text/-less" />

		<link rel="stylesheet/less" href="iconsets/font-awesome/less/font-awesome.less" type="text/css" />

		<script src="lib/misc/less-1.3.3.min.js" type="text/javascript"></script>

		<script src="lib/misc/jquery-1.8.2.min.js" type="text/javascript"></script>
		<script src="build/ergo-js-0.9.2.js" type="text/javascript"></script>

		<script src="incubator/utils.js" type="text/javascript"></script>
		
    <!--script src="http://api-maps.yandex.ru/2.0-stable/?load=package.standard&lang=ru-RU" type="text/javascript"></script-->
	
	
	<style type="text/css">
		
		body {
			padding: 20px;
		}
		
		
		.e-grid-control-row th > span {
			padding-top: 0;
			padding-bottom: 0;
		}

		.e-grid-control-row td > span {
			padding-top: 0;
			padding-bottom: 0;
		}
		
		
		.my-grid td {
			border-right: none;
		}
		
		
		td.editing > span {
			padding: 0px;
		}
		
		
	</style>
	
</head>
<body>
	
	
<script type="text/javascript">

Ergo.alias('icon', Ergo.widgets.FontIcon);


Ergo.declare('Ergo.widgets.grid.TextCell', 'Ergo.widgets.grid.Cell', {
	
	defaults: {
		binding: false,
		content: {
			etype: 'text'
		}
	},
	
	
	setText: function(v) {
		this.content.opt('text', v);
	}
	
}, 'text-cell');









var GridData = Ergo.data.AjaxCollection.extend({
	
	defaults: {
		url: 'samples/ajax/randomdata.csv',
		ajax: {
			dataType: 'text'
		}
	},

	
	parse: function(csv) {
		
		var list = csv.split('\n');
		
		
		this.options.totalCount = list.length;
		
		// Эмулируем загрузку набора данных
		var data = [];
		
		var to = Math.min(list.length, this.options.to);
		
		for(var i = 0; i < 30; i++) {
			
			var a = list[i].split('|');			
			
			data.push({
				id: a[0],
				name: a[1],
				email: a[2],
				date: a[3]
			});
		}
		
		return data;
	}	
	
});

	
var gridData = new GridData();


	
	
var w = $.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Грид',
	cls: 'widget',
	style: {'margin-bottom': 20},

	data: gridData,
	
//	autoFetch: true,
	
	content: {
		
		etype: 'table-grid',
		
		$header_content: {
			mixins: ['resizable-header']
		},
		

		cell: {
			etype: 'text-cell'
		},


		content: {
			mixins: ['scrollable'],
			style: {'padding-right': 13, 'overflow': 'hidden'}
		},
		
		columns: [{
			dataId: 'id',
			header: 'ID',
			width: 30
		}, {
			dataId: 'name',
			header: 'Имя'
		}, {
			dataId: 'email',
			header: 'E-mail'
		}]
				
	}
	
});	


gridData.fetch().then(function(){
	w.$layoutChanged();	
});








$.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Грид + редактирование ячеек',
	cls: 'widget',
	style: {'margin-bottom': 20},
	
	data: new GridData(),
	
	autoFetch: true,
	
	onFetch: function() {
		this.$layoutChanged();
	},
	
	content: {
		
		etype: 'table-grid',
		
		cell: {
			etype: 'text-cell',
			
			mixins: ['editable'],
			onDoubleClick: function() {
				this.startEdit();
			},
			editor: {
				etype: 'input-editor',
				replace: 'content',
				
				style: {'-webkit-user-select': 'auto'},
				
				focusable: true,
				stopOnChange: false,
				onKeyDown: function(e) {
					if(e.keyCode == 13) {
						this.opt('value', this.content.el.val());
//						this.parent.stopEdit();
						
						var next = this.parent.next();
						if(next) 
							next.startEdit();
						else
							this.parent.stopEdit();
					}
					else if(e.keyCode == 27) {
						this.parent.stopEdit();
					}
					
				},
				content: {
					events: {
						'focus': function(e, w) {
							Ergo.focus(w);
						}
					},
					tabIndex: 1
				},
				
				onFocusIn: function() {
					
					var el = $('input', this.el);
					el[0].setSelectionRange(el.val().length, el.val().length);
					
				}
				
			},
			state: 'no-selection'
		},
		
		columns: [{
			dataId: 'name',
			header: 'Имя',
//			width: 100
		}, {
			dataId: 'email',
			header: 'E-mail',
//			width: 200
		}, {
			dataId: 'date',
			header: 'Дата',
//			width: 100
		}],
		
		
		$header_content: {
			mixins: ['resizable-header']
		}
		
		// content: {
			// events: {
				// 'scroll': function(e, w) {
// //					console.log(w.el.scrollLeft());
					// w.parent.header.content.el.css('margin-left', -w.el.scrollLeft());
				// }
			// }
		// }
		
	}

});





var EditableGridData = Ergo.data.Collection.extend({
	
	$construct: function(o) {	
		this.$super(o);
		this._provider = new DummyGridProvider();
	},
	
	
	fetch: function() {
		var self = this;
		return this._provider.get().then(function(data){
			self.set(data);
			self._fetched = true;
		});
	}
	
});




grid = $.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Список + редактирование строк',
	cls: 'widget',
	style: {'margin-bottom': 20},
	
	data: new EditableGridData(),
	
	content: {
		
		cls: 'my-grid',
		
		etype: 'table-grid',
		
		row: {
			mixins: ['effects'],
			effects: {
				hide: 'fadeOut',
				delay: 300
			},
			hideOnDestroy: true
		},
		
		
		cell: {
			mixins: ['editable'],
			editor: {
				etype: 'input-editor',
				stopOnFocusOut: false
			}
		},
		
		columns: [{
			dataId: 'name',
			header: 'Имя'
		}, {
			dataId: 'email',
			header: 'E-mail'
		}, {
			width: 80,
			binding: false,
			editable: false,
			style: {'text-align': 'center'},
			items: [{
				etype: 'icon-button',
				icon: 'icon-pencil',
				onClick: function() {
					this.events.bubble('edit', {target: this.parent});
				}
			}, {
				etype: 'icon-button',
				icon: 'icon-remove',
				onClick: function() {
					this.events.bubble('delete', {target: this.parent});
				}
			}]
		}],
		
		
		onDelete: function(e) {
			var row = e.target;
			row.data.del();
		},

		onEdit: function(e) {
			var row = e.target.parent;
			
			
			var veil = $.ergo({
				etype: 'box',
				style: {'position': 'relative'},
				content: {
					etype: 'box',
					style: {'position': 'absolute', 'background-color': 'rgba(0, 0, 0, 0.1)'},
//					opacity: 0.1,
					content: {
						etype: 'box',
//						opacity: 1,
						style: {'position': 'absolute', 'background-color': '#fff'}
					}
				},
				weight: -1000
			});
			
			this.content.components.set('_veil', veil);			
			
			veil.content.el.width( this.content.el.prop('scrollWidth') );
			veil.content.el.height( this.content.el.prop('scrollHeight') );
			
			var dh = row.el.offset().top - veil.el.offset().top;
			
			var box = veil.content.content;
			
			box.el.width(row.el.outerWidth(true));
			box.el.height(row.el.outerHeight(true));
			
			box.el.css({'top': dh});
			
			
			
			var row_items = [];
			
			row.items.each(function(col) {
				row_items.push({
					width: col.el.width(),
					dataId: col.data.id
				});
				
				if(col.opt('editable')) {
					row_items[row_items.length-1].content = {
						etype: 'input-box',
						width: 0,
						style: {'margin': 7}
					}
				}
				else {
					Ergo.smart_override(row_items[row_items.length-1], {
						items: [{
							etype: 'icon-button',
							icon: 'icon-ok',
							style: {'color': '#9ad902'}
						}, {
							etype: 'icon-button',
							icon: 'icon-ban-circle',
							style: {'color': '#f00'},
							onClick: function() {
								$.when(veil.el.fadeOut(300)).then(function(){
									veil.destroy();									
								});
							}
						}],
						style: {'text-align': 'center'}						
					});
					
				}
				
				
			});
			
			
			var row_editor = $.ergo({
				etype: 'box',
				items: row_items,
				
				cls: 'editor-holder',
				width: '100%',
				defaultItem: {
					style: {'display': 'table-cell', 'border-right': '1px solid transparent'},
				},
				data: row.data
			});
			
			veil.content.content.components.set('_editor', row_editor);
			
			row.items.each(function(col, i) {
				
				if(col.opt('editable')) {
				
					var w = row_editor.item(i).layout.el.innerWidth();
					
					var input = row_editor.item(i).content;
					
					var dw = input.el.outerWidth(true) - input.el.width();
	
					input.el.width(w - dw);
				}
				
			});
			
			
			veil.hide();
			
			veil.el.fadeIn(300);
//			veil.$dataChanged();
			
			// row.column(1).startEdit();
			// row.column(0).startEdit();
		}
		
	}

});

grid.data.fetch().then(function(){
	grid.$layoutChanged();	
});




//new DummyGridProvider().get().then(function(data) { console.log(data); });






var person = {
	id: 5,
	first_name: 'Петр',
	last_name: 'Волков',
	middle_name: 'Николаевич',
	birth_date: '12-08-1972',
	gender: 'female',
	incidents: 3,
	post: 'Ведущий специалист',
	address: '',
	active: false
};





var grid2 = $.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Свойства + редактирование',
	cls: 'widget',
	style: {'margin-bottom': 20},
	
	data: new Ergo.data.Object(person),
	
	content: {
		
		etype: 'property-grid',
		
		// cell: {
// 			
// 			
		// },
		
		// columns: [{
			// header: 'Наименование',
			// content: {
				// etype: 'text',
				// format: function(v) {
					// return this.data.id;// this.options.keyFormat(this.data.id);
				// }
			// },
			// binding: false
		// }, {
			// header: 'Значение',
			// binding: false,			
// 			
// 			
		// }],
		
		
		editorFactory: function() {
			
			console.log(this.data.id);
			
			var o = {etype: 'input-editor'};
			
			var id = this.data.id;
			
			if(id == 'birth_date') {
				o.etype = 'date-editor';
			}
			else if(id == 'post') {
				o = {
					etype: 'dropdown-editor',
					$dropdown_content_items: ['Главный специалист', 'Начальник отдела', 'Ведущий специалист', 'Консультант', 'Стажер']
				};
			}
			else if(id == 'incidents') {
				o.etype = 'spinner-editor';
			}
			else if(id == 'active') {
				o = {
					etype: 'check-box'
				};
				this.el.css('text-align', 'center');
			}
			else if(id == 'id') {
				o.etype = 'text';
			}
			
			
			return o;
		},
		
		
		
		$header_content: {
			mixins: ['resizable-header']
		}
		
	}

});

grid2.$layoutChanged();






</script>
</body>