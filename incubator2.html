<!DOCTYPE html>
<html class="js canvas canvastext geolocation rgba hsla no-multiplebgs borderimage borderradius boxshadow opacity no-cssanimations csscolumns no-cssgradients no-cssreflections csstransforms no-csstransforms3d no-csstransitions  video audio cufon-active fontface cufon-ready">
<head>
	<meta charset="utf-8" />
	
	
		<!-- STYLES -->
	
		<link rel="stylesheet/less" href="css/ergo-js.less" type="text/x-less" />

		<link rel="stylesheet/less" href="themes/default/ergo-theme.less" type="text/-less" />

		<link rel="stylesheet/less" href="iconsets/font-awesome/less/font-awesome.less" type="text/css" />

		<script src="lib/misc/less-1.3.3.min.js" type="text/javascript"></script>

		<script src="lib/misc/jquery-1.8.2.min.js" type="text/javascript"></script>
		<script src="build/ergo-js-0.9.2.js" type="text/javascript"></script>

		<script src="plugins/ergo-growl/ergo-growl.js" type="text/javascript"></script>
		
		<script src="incubator/utils.js" type="text/javascript"></script>
		
    <!--script src="http://api-maps.yandex.ru/2.0-stable/?load=package.standard&lang=ru-RU" type="text/javascript"></script-->
	
	
	<style type="text/css">
		
		body {
			padding: 20px;
		}
		
		
		.e-grid-control-row th > span {
			padding-top: 0;
			padding-bottom: 0;
		}

		.e-grid-control-row td > span {
			padding-top: 0;
			padding-bottom: 0;
		}
		
		
		.my-grid td {
			border-right: none;
		}
		
		
		td.editing > span {
			padding: 0px;
		}
		
	</style>
	
</head>
<body>
	
	
<script type="text/javascript">
	

var GridData = Ergo.data.AjaxCollection.extend({
	
	defaults: {
		url: 'samples/ajax/randomdata.csv',
		ajax: {
			dataType: 'text'
		}
	},

	
	parse: function(csv) {
		
		var list = csv.split('\n');
		
		
		this.options.totalCount = list.length;
		
		// Эмулируем загрузку набора данных
		var data = [];
		
		var to = Math.min(list.length, this.options.to);
		
		for(var i = 0; i < 30; i++) {
			
			var a = list[i].split('|');			
			
			data.push({
				id: a[0],
				name: a[1],
				email: a[2],
				date: a[3]
			});
		}
		
		return data;
	}	
	
});

	
var gridData = new GridData();


	
	
var w = $.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Грид',
	cls: 'widget',
	style: {'margin-bottom': 20},

	data: gridData,
	
//	autoFetch: true,
	
	content: {
		
		etype: 'table-grid',
		
/*		
		components: {
			header: {
				content: {
					cell: {
						layout: {
							html: '<span/>'
						}				
					}
				}
			}
		},
		
		
		cell: {
			layout: {
				html: '<span/>'
			}
		},
*/		
		content: {
			mixins: ['scrollable'],
			style: {'padding-right': 13, 'overflow': 'hidden'}
		},
		
		columns: [{
			dataId: 'id',
			header: 'ID',
			width: 30
		}, {
			dataId: 'name',
			header: 'Имя'
		}, {
			dataId: 'email',
			header: 'E-mail'
		}]
		
	}
	
});	


gridData.fetch().then(function(){
	w.$layoutChanged();	
});








$.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Грид + редактирование ячеек',
	cls: 'widget',
	style: {'margin-bottom': 20},
	
	data: new GridData(),
	
	autoFetch: true,
	
	content: {
		
		etype: 'table-grid',
		
		cell: {
			
			content: {
				etype: 'text'
			},
			
			binding: false,
			
			mixins: ['editable'],
			onDoubleClick: function() {
				this.startEdit();
			},
			editor: {
				etype: 'input-editor',
				replace: 'content'
			},
			state: 'no-selection'
		},
		
		columns: [{
			dataId: 'name',
			header: 'Имя'
		}, {
			dataId: 'email',
			header: 'E-mail'
		}]
		
	}

});





var EditableGridData = Ergo.data.Collection.extend({
	
	$construct: function(o) {	
		this.$super(o);
		this._provider = new DummyGridProvider();
	},
	
	
	fetch: function() {
		var self = this;
		return this._provider.get().then(function(data){
			self.set(data);
			self._fetched = true;
		});
	}
	
});



grid = $.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Грид + редактирование строк',
	cls: 'widget',
	style: {'margin-bottom': 20},
	
	data: new EditableGridData(),
	
	content: {
		
		cls: 'my-grid',
		
		etype: 'table-grid',
		
		row: {
			mixins: ['effects'],
			effects: {
				hide: 'fadeOut',
				delay: 300
			},
			hideOnDestroy: true
		},
		
		
		cell: {
			mixins: ['editable'],
			editor: {
				etype: 'input-editor',
				stopOnFocusOut: false
			}
		},
		
		columns: [{
			dataId: 'name',
			header: 'Имя'
		}, {
			dataId: 'email',
			header: 'E-mail'
		}, {
			width: 80,
			binding: false,
			editable: false,
			style: {'text-align': 'center'},
			items: [{
				etype: 'icon-button',
				icon: 'icon-pencil',
				onClick: function() {
					this.events.bubble('edit', {target: this.parent});
				}
			}, {
				etype: 'icon-button',
				icon: 'icon-remove',
				onClick: function() {
					this.events.bubble('delete', {target: this.parent});
				}
			}]
		}],
		
		
		onDelete: function(e) {
			var row = e.target;
			row.data.del();
		},

		onEdit: function(e) {
			var row = e.target.parent;
			
			
			var veil = $.ergo({
				etype: 'box',
				style: {'position': 'relative'},
				content: {
					etype: 'box',
					style: {'position': 'absolute', 'background-color': '#000'},
					opacity: 0.1,
					content: {
						etype: 'box',
						opacity: 1,
						style: {'position': 'absolute', 'background-color': '#fff'}
					}
				},
				weight: -1000
			});
			
			this.content.components.set('_veil', veil);			
			
			veil.content.el.width( this.content.el.prop('scrollWidth') );
			veil.content.el.height( this.content.el.prop('scrollHeight') );
			
			var dh = row.el.offset().top - veil.el.offset().top;
			
			var box = veil.content.content;
			
			box.el.width(row.el.outerWidth(true));
			box.el.height(row.el.outerHeight(true));
			
			box.el.css({'top': dh});
			
			
			// row.column(1).startEdit();
			// row.column(0).startEdit();
		}
		
	}

});

grid.data.fetch().then(function(){
	grid.$layoutChanged();	
});




//new DummyGridProvider().get().then(function(data) { console.log(data); });



</script>
</body>