<!DOCTYPE html>
<html class="js canvas canvastext geolocation rgba hsla no-multiplebgs borderimage borderradius boxshadow opacity no-cssanimations csscolumns no-cssgradients no-cssreflections csstransforms no-csstransforms3d no-csstransitions  video audio cufon-active fontface cufon-ready">
<head>
	<meta charset="utf-8" />
	
	
		<!-- STYLES -->
	
		<link rel="stylesheet/less" href="css/ergo-js.less" type="text/x-less" />

		<link rel="stylesheet/less" href="themes/default/ergo-theme.less" type="text/-less" />

		<link rel="stylesheet/less" href="iconsets/font-awesome/less/font-awesome.less" type="text/css" />

		<script src="lib/misc/less-1.3.3.min.js" type="text/javascript"></script>

		<script src="lib/misc/jquery-1.8.2.min.js" type="text/javascript"></script>
		<script src="build/ergo-js-0.9.2.js" type="text/javascript"></script>

		<script src="incubator/utils.js" type="text/javascript"></script>
		
    <!--script src="http://api-maps.yandex.ru/2.0-stable/?load=package.standard&lang=ru-RU" type="text/javascript"></script-->
	
	
	<style type="text/css">
		
		body {
			padding: 20px;
		}
		
		
		.e-grid-control-row th > span {
			padding-top: 0;
			padding-bottom: 0;
		}

		.e-grid-control-row td > span {
			padding-top: 0;
			padding-bottom: 0;
		}
		
		
		.my-grid td {
			border-right: none;
		}
		
		
		td.editing > span {
			padding: 0px;
		}
		
	</style>
	
</head>
<body>
	
	
<script type="text/javascript">

Ergo.alias('icon', Ergo.widgets.FontIcon);


Ergo.declare('Ergo.widgets.grid.TextCell', 'Ergo.widgets.grid.Cell', {
	
	defaults: {
		content: {
			etype: 'text'
		}
	},
	
	
	setText: function(v) {
		this.content.opt('text', v);
	}
	
}, 'text-cell');









var GridData = Ergo.data.AjaxCollection.extend({
	
	defaults: {
		url: 'samples/ajax/randomdata.csv',
		ajax: {
			dataType: 'text'
		}
	},

	
	parse: function(csv) {
		
		var list = csv.split('\n');
		
		
		this.options.totalCount = list.length;
		
		// Эмулируем загрузку набора данных
		var data = [];
		
		var to = Math.min(list.length, this.options.to);
		
		for(var i = 0; i < 30; i++) {
			
			var a = list[i].split('|');			
			
			data.push({
				id: a[0],
				name: a[1],
				email: a[2],
				date: a[3]
			});
		}
		
		return data;
	}	
	
});

	
var gridData = new GridData();


	
	
var w = $.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Грид',
	cls: 'widget',
	style: {'margin-bottom': 20},

	data: gridData,
	
//	autoFetch: true,
	
	content: {
		
		etype: 'table-grid',
		
/*		
		components: {
			header: {
				content: {
					cell: {
						layout: {
							html: '<span/>'
						}				
					}
				}
			}
		},
		
		
		cell: {
			layout: {
				html: '<span/>'
			}
		},
*/	

		cell: {
			etype: 'text-cell'
		},


		content: {
			mixins: ['scrollable'],
			style: {'padding-right': 13, 'overflow': 'hidden'}
		},
		
		columns: [{
			dataId: 'id',
			header: 'ID',
			width: 30
		}, {
			dataId: 'name',
			header: 'Имя'
		}, {
			dataId: 'email',
			header: 'E-mail'
		}],
		
		
		
		$header_content: {
			defaultItem: {
				defaultItem: {
					events: {
						'mousemove': function(e, w) {
							var width = w.el.width();
							var offset = w.el.offset();
							var x = e.pageX;
							
							var dx = offset.left + width - x
							
							if(dx < 4) {
								w.el.css('cursor', 'col-resize');
								w.states.set('resize');
							}
							else {
								w.el.css('cursor', 'default');
								w.states.unset('resize');
							}
							
//							console.log( offset.left + width - x );
						},
						'mousedown': function(e, w) {
							
							if( !w.states.is('resize') ) return;
							
							
							var offset = w.el.offset();
							
							var c = w.parent.parent.parent.parent;
							
							// добавляем "призрака"
							var ghost = $('<div class="ghost"/>');
							ghost.css({'top': offset.top, 'left': e.pageX, width: 2, height: c.el.height()});
							$('body').append(ghost);
							
							
							var from_x = e.pageX;
							var max_x = c.el.offset().left + c.el.width();
							var min_x = c.el.offset().left;
							
							var gp = Ergo.glass_pane()
								.on('mousemove', function(e2){
									
									// var dx = e2.pageX - from_x;
									// dx = Math.min(dx, max_dx);
									// dx = Math.max(dx, min_dx);
									
									var x = e2.pageX;
									x = Math.min(x, max_x);
									x = Math.max(x, min_x);
									
									ghost.css({'left': x});
									
								})
								.on('mouseup', function(e2){

									gp.remove();
									ghost.remove();
									
									var dx = e2.pageX - from_x;
									
//									w.el.width(  );
									
									w.events.bubble('columnResize', {i: w._index, width: w.el.width() + dx});
//									w.parent.parent.control.item(w._index).el.width( w.el.width() + dx );
									
									// var dx = e2.pageX - from_x;
									// dx = Math.min(dx, max_dx);
									// dx = Math.max(dx, min_dx);
// 									
									// if(w.opt('invert')) dx = -dx;
									
//									update.opt('width', update.opt('width')+dx);
									
//									left.$layoutChanged();
//									right.$layoutChanged();
			//								w.parent.west.opt('width', w.parent.west.opt('width')+dx);
									
								})
							
							gp.css('cursor', 'col-resize');
							$('body').append(gp);
							
							
							
							
						}
					}
				}
			}
		}
		
	}
	
});	


gridData.fetch().then(function(){
	w.$layoutChanged();	
});








$.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Грид + редактирование ячеек',
	cls: 'widget',
	style: {'margin-bottom': 20},
	
	data: new GridData(),
	
	autoFetch: true,
	
	onFetch: function() {
		console.log( this.content.content.content.el.width() );
		this.$layoutChanged();
	},
	
	content: {
		
		etype: 'table-grid',
		
		cell: {
			
			content: {
				etype: 'text'
			},
			
			binding: false,
			
			mixins: ['editable'],
			onDoubleClick: function() {
				this.startEdit();
			},
			editor: {
				etype: 'input-editor',
				replace: 'content',
				
				style: {'-webkit-user-select': 'auto'},
				
				focusable: true,
				stopOnChange: false,
				onKeyDown: function(e) {
					if(e.keyCode == 13) {
						this.opt('value', this.content.el.val());
//						this.parent.stopEdit();
						
						var next = this.parent.next();
						if(next) 
							next.startEdit();
						else
							this.parent.stopEdit();
					}
					else if(e.keyCode == 27) {
						this.parent.stopEdit();
					}
					
				},
				content: {
					events: {
						'focus': function(e, w) {
							Ergo.focus(w);
						}
					},
					tabIndex: 1
				},
				
				onFocusIn: function() {
					
					var el = $('input', this.el);
					el[0].setSelectionRange(el.val().length, el.val().length);
					
				}
				
			},
			state: 'no-selection'
		},
		
		columns: [{
			dataId: 'name',
			header: 'Имя'
		}, {
			dataId: 'email',
			header: 'E-mail'
		}, {
			dataId: 'date',
			header: 'Дата'
		}],
		
		
		$header_content: {
			defaultItem: {
				defaultItem: {
					mixins: ['resizable-cell']
				}
			}
		}
		
	}

});





var EditableGridData = Ergo.data.Collection.extend({
	
	$construct: function(o) {	
		this.$super(o);
		this._provider = new DummyGridProvider();
	},
	
	
	fetch: function() {
		var self = this;
		return this._provider.get().then(function(data){
			self.set(data);
			self._fetched = true;
		});
	}
	
});



grid = $.ergo({
	etype: 'panel',
	renderTo: 'body',
	width: 600,
	height: 300,
	title: 'Список + редактирование строк',
	cls: 'widget',
	style: {'margin-bottom': 20},
	
	data: new EditableGridData(),
	
	content: {
		
		cls: 'my-grid',
		
		etype: 'table-grid',
		
		row: {
			mixins: ['effects'],
			effects: {
				hide: 'fadeOut',
				delay: 300
			},
			hideOnDestroy: true
		},
		
		
		cell: {
			mixins: ['editable'],
			editor: {
				etype: 'input-editor',
				stopOnFocusOut: false
			}
		},
		
		columns: [{
			dataId: 'name',
			header: 'Имя'
		}, {
			dataId: 'email',
			header: 'E-mail'
		}, {
			width: 80,
			binding: false,
			editable: false,
			style: {'text-align': 'center'},
			items: [{
				etype: 'icon-button',
				icon: 'icon-pencil',
				onClick: function() {
					this.events.bubble('edit', {target: this.parent});
				}
			}, {
				etype: 'icon-button',
				icon: 'icon-remove',
				onClick: function() {
					this.events.bubble('delete', {target: this.parent});
				}
			}]
		}],
		
		
		onDelete: function(e) {
			var row = e.target;
			row.data.del();
		},

		onEdit: function(e) {
			var row = e.target.parent;
			
			
			var veil = $.ergo({
				etype: 'box',
				style: {'position': 'relative'},
				content: {
					etype: 'box',
					style: {'position': 'absolute', 'background-color': 'rgba(0, 0, 0, 0.1)'},
//					opacity: 0.1,
					content: {
						etype: 'box',
//						opacity: 1,
						style: {'position': 'absolute', 'background-color': '#fff'}
					}
				},
				weight: -1000
			});
			
			this.content.components.set('_veil', veil);			
			
			veil.content.el.width( this.content.el.prop('scrollWidth') );
			veil.content.el.height( this.content.el.prop('scrollHeight') );
			
			var dh = row.el.offset().top - veil.el.offset().top;
			
			var box = veil.content.content;
			
			box.el.width(row.el.outerWidth(true));
			box.el.height(row.el.outerHeight(true));
			
			box.el.css({'top': dh});
			
			
			
			var row_items = [];
			
			row.items.each(function(col) {
				row_items.push({
					width: col.el.width(),
					dataId: col.data.id
				});
				
				if(col.opt('editable')) {
					row_items[row_items.length-1].content = {
						etype: 'input-box',
						width: 0,
						style: {'margin': 7}
					}
				}
				else {
					Ergo.smart_override(row_items[row_items.length-1], {
						items: [{
							etype: 'icon-button',
							icon: 'icon-ok',
							style: {'color': '#9ad902'}
						}, {
							etype: 'icon-button',
							icon: 'icon-ban-circle',
							style: {'color': '#f00'},
							onClick: function() {
								$.when(veil.el.fadeOut(300)).then(function(){
									veil.destroy();									
								});
							}
						}],
						style: {'text-align': 'center'}						
					});
					
				}
				
				
			});
			
			
			var row_editor = $.ergo({
				etype: 'box',
				items: row_items,
				
				cls: 'editor-holder',
				width: '100%',
				defaultItem: {
					style: {'display': 'table-cell', 'border-right': '1px solid transparent'},
				},
				data: row.data
			});
			
			veil.content.content.components.set('_editor', row_editor);
			
			row.items.each(function(col, i) {
				
				if(col.opt('editable')) {
				
					var w = row_editor.item(i).layout.el.innerWidth();
					
					var input = row_editor.item(i).content;
					
					var dw = input.el.outerWidth(true) - input.el.width();
	
					input.el.width(w - dw);
				}
				
			});
			
			
			veil.hide();
			
			veil.el.fadeIn(300);
//			veil.$dataChanged();
			
			// row.column(1).startEdit();
			// row.column(0).startEdit();
		}
		
	}

});

grid.data.fetch().then(function(){
	grid.$layoutChanged();	
});




//new DummyGridProvider().get().then(function(data) { console.log(data); });



</script>
</body>